<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジェンベ譜面作成アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .part {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #fafafa;
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .part-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            border: 2px solid transparent;
            padding: 8px 12px;
            border-radius: 5px;
            background: transparent;
            transition: all 0.2s;
            min-width: 150px;
        }

        .part-title:hover {
            border-color: #ddd;
            background: #f9f9f9;
        }

        .part-title:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .delete-part {
            background: #e74c3c;
            padding: 8px 18px;
            font-size: 13px;
        }

        .delete-part:hover {
            background: #c0392b;
        }

        .section-label {
            font-size: 16px;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            padding-left: 8px;
            border-left: 4px solid #667eea;
        }

        .symbol-palette {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .symbol-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .symbol-label {
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .symbol-btn {
            width: 55px;
            height: 55px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 30px;
            font-family: "Segoe UI Symbol", "Apple Symbols", "Noto Sans Symbols", Arial, sans-serif;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .symbol-btn:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .symbol-btn.selected {
            background: #667eea;
            border: 4px solid #4c5ed0;
            color: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.8), 0 0 0 2px rgba(102, 126, 234, 0.3);
            transform: scale(1.05);
        }

        .symbol-btn.selected:hover {
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(102, 126, 234, 1), 0 0 0 3px rgba(102, 126, 234, 0.4);
        }

        .grid-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .grid-row {
            display: flex;
            gap: 3px;
            margin-bottom: 15px;
            align-items: center;
        }

        .row-label {
            font-size: 13px;
            color: #666;
            font-weight: bold;
            min-width: 35px;
            margin-right: 8px;
        }

        .grid-cells {
            display: flex;
            gap: 3px;
        }

        .grid-cell {
            width: 45px;
            height: 55px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            font-size: 22px;
            font-family: "Segoe UI Symbol", "Apple Symbols", "Noto Sans Symbols", Arial, sans-serif;
            font-weight: bold;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .grid-cell:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .grid-cell.measure-start {
            border-left: 3px solid #333;
            background: #f9f9f9;
        }

        .grid-cell.has-symbol {
            background: #e8f0fe;
        }

        .grid-cell.beat-selected {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .grid-cell.beat-selected.has-symbol {
            background: #ffe8a1;
        }

        .add-row-btn {
            margin-top: 15px;
            background: #27ae60;
            padding: 10px 20px;
            font-size: 14px;
        }

        .add-row-btn:hover {
            background: #229954;
        }

        .info {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 14px;
            color: #2e7d32;
            line-height: 1.6;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 22px;
            }

            .symbol-btn {
                width: 50px;
                height: 50px;
                font-size: 26px;
            }

            .grid-cell {
                width: 40px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ジェンベ譜面作成アプリ</h1>

        <div class="controls">
            <button id="addPart">パート追加</button>
            <button id="saveBtn">保存</button>
            <button id="loadBtn">読込</button>
            <button id="clearBtn">クリア</button>
            <input type="file" id="fileInput" class="file-input" accept=".json">
        </div>

        <div id="parts"></div>

        <div class="info">
            <strong>操作方法:</strong><br>
            1. 記号をクリックして選択 → グリッド上をクリックで配置 → 配置済みの記号をクリックで削除<br>
            2. パート名はクリックして編集可能<br>
            3. 小節をクリックすると、その小節全体が黄色でハイライト表示されます
        </div>
    </div>

    <script>
        // アプリの状態管理
        const app = {
            parts: [],
            selectedSymbol: null,
            selectedBeatGroup: null, // { partId, row, measureIndex }
            partIdCounter: 0
        };

        // 記号定義（8種類）
        const SYMBOLS = [
            { name: 'ベース', symbol: '□' },
            { name: 'トーン', symbol: '○' },
            { name: 'スラップ', symbol: '△' },
            { name: 'ベース(ミュート)', symbol: '■' },
            { name: 'トーン(ミュート)', symbol: '●' },
            { name: 'スラップ(ミュート)', symbol: '▲' },
            { name: 'ロール', symbol: '≡' },
            { name: 'フラム', symbol: '≈' }
        ];

        // 初期化
        function init() {
            loadFromLocalStorage();
            if (app.parts.length === 0) {
                addPart();
            }
            setupEventListeners();
            render();
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            document.getElementById('addPart').addEventListener('click', addPart);
            document.getElementById('saveBtn').addEventListener('click', saveToFile);
            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', loadFromFile);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
        }

        // パート追加
        function addPart() {
            if (app.parts.length >= 4) {
                alert('パートは最大4つまでです');
                return;
            }
            const part = {
                id: app.partIdCounter++,
                name: `パート${app.parts.length + 1}`,
                notes: {},
                rowConfigs: [
                    { beats: [4, 4] },  // 1行目: 両小節とも4連
                    { beats: [4, 4] },  // 2行目
                    { beats: [4, 4] },  // 3行目
                    { beats: [4, 4] }   // 4行目
                ]
            };
            app.parts.push(part);
            render();
            saveToLocalStorage();
        }

        // パート削除
        function deletePart(partId) {
            app.parts = app.parts.filter(p => p.id !== partId);
            render();
            saveToLocalStorage();
        }

        // パート名更新
        function updatePartName(partId, newName) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;
            part.name = newName;
        }

        // 行追加
        function addRow(partId) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;
            part.rowConfigs.push({ beats: [4, 4] });  // デフォルトは両小節とも4連
            render();
            saveToLocalStorage();
        }

        // 指定行のマス数を取得
        function getCellsForRow(rowConfig) {
            return rowConfig.beats[0] + rowConfig.beats[1];
        }

        // 指定列が属する小節の情報を取得
        function getMeasureInfo(rowConfig, col) {
            const measure1Beats = rowConfig.beats[0];
            if (col < measure1Beats) {
                return { measureIndex: 0, beats: measure1Beats, startCol: 0 };
            } else {
                return { measureIndex: 1, beats: rowConfig.beats[1], startCol: measure1Beats };
            }
        }

        // 行とセルから累積positionを計算
        function calculatePosition(part, row, col) {
            let position = 0;
            // 前の行までの累積マス数を加算
            for (let r = 0; r < row; r++) {
                position += getCellsForRow(part.rowConfigs[r]);
            }
            // 現在の行のcol位置を加算
            position += col;
            return position;
        }

        // レンダリング
        function render() {
            const partsContainer = document.getElementById('parts');
            partsContainer.innerHTML = '';

            app.parts.forEach(part => {
                const partDiv = document.createElement('div');
                partDiv.className = 'part';

                // パートヘッダー
                const header = document.createElement('div');
                header.className = 'part-header';

                // パート名入力欄
                const partNameInput = document.createElement('input');
                partNameInput.type = 'text';
                partNameInput.className = 'part-title';
                partNameInput.value = part.name;
                partNameInput.addEventListener('input', (e) => updatePartName(part.id, e.target.value));
                partNameInput.addEventListener('blur', () => saveToLocalStorage());

                // 削除ボタン
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-part';
                deleteBtn.textContent = '削除';
                deleteBtn.onclick = () => deletePart(part.id);

                header.appendChild(partNameInput);
                header.appendChild(deleteBtn);
                partDiv.appendChild(header);

                // 音の種類ラベル
                const soundTypeLabel = document.createElement('div');
                soundTypeLabel.className = 'section-label';
                soundTypeLabel.textContent = '音の種類';
                partDiv.appendChild(soundTypeLabel);

                // 記号パレット
                const palette = document.createElement('div');
                palette.className = 'symbol-palette';
                SYMBOLS.forEach(sym => {
                    const item = document.createElement('div');
                    item.className = 'symbol-item';

                    const btn = document.createElement('button');
                    btn.className = 'symbol-btn';
                    // 現在選択中の記号と一致する場合、selectedクラスを追加
                    if (app.selectedSymbol === sym.symbol) {
                        btn.classList.add('selected');
                    }
                    btn.textContent = sym.symbol;
                    btn.title = sym.name;
                    btn.onclick = () => selectSymbol(part.id, sym.symbol);

                    const label = document.createElement('div');
                    label.className = 'symbol-label';
                    label.textContent = sym.name;

                    item.appendChild(btn);
                    item.appendChild(label);
                    palette.appendChild(item);
                });
                partDiv.appendChild(palette);

                // 譜面欄ラベル
                const scoreLabel = document.createElement('div');
                scoreLabel.className = 'section-label';
                scoreLabel.textContent = '譜面欄';
                partDiv.appendChild(scoreLabel);

                // グリッド
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid-container';

                const rows = part.rowConfigs.length;

                // 行ごとにグリッドを作成
                for (let row = 0; row < rows; row++) {
                    const rowConfig = part.rowConfigs[row];
                    const gridRow = document.createElement('div');
                    gridRow.className = 'grid-row';

                    // 行ラベル
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = `${row + 1}:`;
                    gridRow.appendChild(rowLabel);

                    // セルコンテナ
                    const gridCells = document.createElement('div');
                    gridCells.className = 'grid-cells';

                    const cellsInRow = getCellsForRow(rowConfig);

                    for (let col = 0; col < cellsInRow; col++) {
                        const position = calculatePosition(part, row, col);
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';

                        // 小節の区切り（各小節の開始位置）
                        const measureInfo = getMeasureInfo(rowConfig, col);
                        if (col === 0 || col === measureInfo.startCol) {
                            cell.classList.add('measure-start');
                        }

                        // ビートグループ選択状態のハイライト
                        if (app.selectedBeatGroup &&
                            app.selectedBeatGroup.partId === part.id &&
                            app.selectedBeatGroup.row === row &&
                            app.selectedBeatGroup.measureIndex === measureInfo.measureIndex) {
                            cell.classList.add('beat-selected');
                        }

                        // 配置されている記号を表示
                        if (part.notes[position]) {
                            cell.textContent = part.notes[position];
                            cell.classList.add('has-symbol');
                        }

                        cell.onclick = () => placeOrRemoveSymbol(part.id, position, row, col);
                        gridCells.appendChild(cell);
                    }

                    gridRow.appendChild(gridCells);
                    gridContainer.appendChild(gridRow);
                }

                // 行追加ボタン
                const addRowButton = document.createElement('button');
                addRowButton.className = 'add-row-btn';
                addRowButton.textContent = '+ 行を追加';
                addRowButton.onclick = () => addRow(part.id);
                gridContainer.appendChild(addRowButton);

                partDiv.appendChild(gridContainer);
                partsContainer.appendChild(partDiv);
            });
        }

        // 記号選択
        function selectSymbol(partId, symbol) {
            if (app.selectedSymbol === symbol) {
                app.selectedSymbol = null;
            } else {
                app.selectedSymbol = symbol;
            }
            render();
        }

        // 記号の配置または削除
        function placeOrRemoveSymbol(partId, position, row, col) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;

            // ビートグループ選択状態を更新
            const rowConfig = part.rowConfigs[row];
            const measureInfo = getMeasureInfo(rowConfig, col);
            app.selectedBeatGroup = {
                partId: partId,
                row: row,
                measureIndex: measureInfo.measureIndex
            };

            if (part.notes[position]) {
                // 既に記号がある場合は削除
                delete part.notes[position];
            } else if (app.selectedSymbol) {
                // 記号を配置
                part.notes[position] = app.selectedSymbol;
            }

            render();
            saveToLocalStorage();
        }

        // ファイルに保存
        function saveToFile() {
            const data = {
                parts: app.parts.map(p => ({
                    name: p.name,
                    rowConfigs: p.rowConfigs,
                    notes: p.notes
                }))
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `djembe-score-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ファイルから読込
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    app.parts = data.parts.map((p, index) => ({
                        id: app.partIdCounter++,
                        name: p.name || `パート${index + 1}`,
                        rowConfigs: p.rowConfigs || [{ beats: [4, 4] }],
                        notes: p.notes || {}
                    }));

                    render();
                    saveToLocalStorage();
                    alert('譜面を読み込みました');
                } catch (error) {
                    alert('ファイルの読み込みに失敗しました');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // LocalStorageに保存
        function saveToLocalStorage() {
            try {
                const data = {
                    parts: app.parts,
                    partIdCounter: app.partIdCounter
                };
                localStorage.setItem('djembeScore', JSON.stringify(data));
            } catch (error) {
                console.error('LocalStorageへの保存に失敗:', error);
            }
        }

        // LocalStorageから読込
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('djembeScore');
                if (data) {
                    const parsed = JSON.parse(data);
                    app.parts = (parsed.parts || []).map(p => ({
                        ...p,
                        rowConfigs: p.rowConfigs || [{ beats: [4, 4] }]
                    }));
                    app.partIdCounter = parsed.partIdCounter || 0;
                }
            } catch (error) {
                console.error('LocalStorageからの読み込みに失敗:', error);
            }
        }

        // 全クリア
        function clearAll() {
            if (confirm('すべてのデータをクリアしますか？')) {
                app.parts = [];
                app.selectedSymbol = null;
                app.selectedBeatGroup = null;
                app.partIdCounter = 0;
                addPart();
                saveToLocalStorage();
            }
        }

        // アプリ起動
        init();
    </script>
</body>
</html>
