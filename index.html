<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ジェンベ譜面作成アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .part {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #fafafa;
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .part-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            border: 2px solid transparent;
            padding: 8px 12px;
            border-radius: 5px;
            background: transparent;
            transition: all 0.2s;
            min-width: 150px;
        }

        .part-title:hover {
            border-color: #ddd;
            background: #f9f9f9;
        }

        .part-title:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .delete-part {
            background: #e74c3c;
            padding: 8px 18px;
            font-size: 13px;
        }

        .delete-part:hover {
            background: #c0392b;
        }

        .section-label {
            font-size: 16px;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            padding-left: 8px;
            border-left: 4px solid #667eea;
        }

        .symbol-palette {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            -webkit-overflow-scrolling: touch;
        }

        .symbol-divider {
            width: 2px;
            background: #999;
            margin: 0 15px;
            align-self: stretch;
        }

        .symbol-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .symbol-label {
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .symbol-btn {
            width: 55px;
            height: 55px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 30px;
            font-family: "Segoe UI Symbol", "Apple Symbols", "Noto Sans Symbols", Arial, sans-serif;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .symbol-btn:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

        .symbol-btn.selected {
            background: #667eea;
            border: 4px solid #4c5ed0;
            color: white;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.8), 0 0 0 2px rgba(102, 126, 234, 0.3);
            transform: scale(1.05);
        }

        .symbol-btn.selected:hover {
            transform: scale(1.08);
            box-shadow: 0 0 20px rgba(102, 126, 234, 1), 0 0 0 3px rgba(102, 126, 234, 0.4);
        }

        .grid-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .grid-row {
            display: flex;
            gap: 3px;
            margin-bottom: 15px;
            align-items: center;
        }

        .grid-row-content {
            display: flex;
            gap: 3px;
            align-items: center;
            overflow-x: auto;
            width: 100%;
        }

        .row-label {
            font-size: 13px;
            color: #666;
            font-weight: bold;
            min-width: 35px;
            margin-right: 8px;
        }

        .grid-cells {
            display: flex;
            gap: 3px;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .beat-controls {
            display: flex;
            gap: 8px;
            margin-left: 15px;
            align-items: center;
        }

        .row-action-controls {
            display: flex;
            gap: 8px;
            margin-left: 15px;
            align-items: center;
        }

        .beat-label {
            font-size: 12px;
            color: #666;
            margin-right: 5px;
        }

        .beat-toggle {
            padding: 6px 12px;
            font-size: 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 50px;
        }

        .beat-toggle:hover {
            background: #e0e0e0;
            border-color: #999;
        }

        .beat-toggle.active-4 {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .beat-toggle.active-3 {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .grid-cell {
            width: 45px;
            height: 55px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            font-size: 22px;
            font-family: "Segoe UI Symbol", "Apple Symbols", "Noto Sans Symbols", Arial, sans-serif;
            font-weight: bold;
            transition: all 0.2s;
            border-radius: 4px;
        }

        .grid-cell:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .grid-cell.measure-start {
            border-left: 3px solid #333;
            background: #f9f9f9;
        }

        .grid-cell.has-symbol {
            background: #e8f0fe;
        }

        .grid-cell.beat-selected {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .grid-cell.beat-selected.has-symbol {
            background: #ffe8a1;
        }

        .add-row-btn {
            margin-top: 15px;
            background: #27ae60;
            padding: 10px 20px;
            font-size: 14px;
        }

        .add-row-btn:hover {
            background: #229954;
        }

        .info {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 14px;
            color: #2e7d32;
            line-height: 1.8;
            text-align: left;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 10px;
                max-width: 100%;
            }

            h1 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .controls {
                padding: 10px;
                gap: 8px;
            }

            button {
                padding: 8px 12px;
                font-size: 12px;
            }

            .part {
                padding: 10px;
                margin-bottom: 20px;
            }

            .part-header {
                flex-wrap: wrap;
                gap: 8px;
            }

            .part-title {
                font-size: 16px;
                padding: 6px 10px;
                min-width: 120px;
            }

            .delete-part {
                padding: 6px 12px;
                font-size: 11px;
            }

            .section-label {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .symbol-palette {
                gap: 6px;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
                padding-right: 20px;
            }

            .symbol-divider {
                margin: 0 8px;
                flex-shrink: 0;
            }

            .symbol-item {
                flex-shrink: 0;
            }

            .symbol-item:last-child {
                margin-right: 30px;
            }

            .symbol-label {
                font-size: 9px;
            }

            .symbol-btn {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }

            .symbol-btn.selected {
                border: 3px solid #4c5ed0;
            }

            .grid-container {
                padding: 10px;
                overflow-x: auto;
            }

            .grid-row {
                margin-bottom: 10px;
                gap: 2px;
                flex-wrap: wrap;
            }

            .grid-row > .row-label {
                width: 100%;
                margin-bottom: 5px;
                margin-right: 0;
            }

            .grid-row > .grid-cells {
                width: 100%;
                overflow-x: auto;
            }

            .row-label {
                font-size: 11px;
                min-width: 25px;
                margin-right: 5px;
            }

            .grid-cells {
                gap: 2px;
            }

            .grid-cell {
                width: 32px;
                height: 40px;
                font-size: 16px;
                border-radius: 3px;
            }

            .grid-cell.measure-start {
                border-left: 2px solid #333;
            }

            .beat-controls {
                gap: 4px;
                margin-left: 0;
                flex-wrap: wrap;
                width: 100%;
                justify-content: flex-start;
            }

            .row-action-controls {
                gap: 4px;
                margin-left: 0;
                flex-wrap: wrap;
                width: 100%;
                justify-content: flex-start;
            }

            .beat-toggle {
                padding: 4px 8px;
                font-size: 10px;
                min-width: 40px;
            }

            .add-row-btn {
                margin-top: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }

            .info {
                margin-top: 15px;
                padding: 10px;
                font-size: 10px;
                line-height: 1.7;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 8px;
            }

            h1 {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .controls {
                padding: 8px;
                gap: 6px;
            }

            button {
                padding: 6px 10px;
                font-size: 11px;
            }

            .part {
                padding: 8px;
                margin-bottom: 15px;
            }

            .part-title {
                font-size: 14px;
                padding: 5px 8px;
                min-width: 100px;
            }

            .section-label {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .symbol-palette {
                gap: 4px;
                padding-right: 25px;
            }

            .symbol-divider {
                margin: 0 5px;
                flex-shrink: 0;
            }

            .symbol-item:last-child {
                margin-right: 40px;
            }

            .symbol-label {
                font-size: 8px;
            }

            .symbol-btn {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .grid-container {
                padding: 8px;
            }

            .grid-row {
                margin-bottom: 8px;
                flex-wrap: wrap;
            }

            .grid-row > .row-label {
                width: 100%;
                margin-bottom: 5px;
                margin-right: 0;
            }

            .grid-row > .grid-cells {
                width: 100%;
                overflow-x: auto;
            }

            .row-label {
                font-size: 10px;
                min-width: 20px;
                margin-right: 4px;
            }

            .grid-cell {
                width: 28px;
                height: 36px;
                font-size: 14px;
            }

            .beat-controls {
                gap: 3px;
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
            }

            .row-action-controls {
                gap: 3px;
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
            }

            .beat-toggle {
                padding: 3px 6px;
                font-size: 9px;
                min-width: 35px;
            }

            .add-row-btn {
                padding: 6px 12px;
                font-size: 11px;
            }

            .info {
                padding: 8px;
                font-size: 9px;
                line-height: 1.6;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ジェンベ譜面作成アプリ</h1>

        <div class="controls">
            <button id="addPart">パート追加</button>
            <button id="saveBtn">保存</button>
            <button id="loadBtn">読込</button>
            <button id="clearBtn">クリア</button>
            <input type="file" id="fileInput" class="file-input" accept=".json">
        </div>

        <div id="parts"></div>

        <div class="info">
            <strong>操作方法:</strong><br>
            1. 記号選択 → グリッドに配置<br>
            2. フラム（≈）で装飾ON/OFF<br>
            　ONの時：基本音+フラム（例: □≈）<br>
            3. パート名クリックで編集<br>
            4. 小節クリックで黄色ハイライト<br>
            5. 4連/3連ボタンで小節切替<br>
            6. コピー/貼付で行を複製
        </div>
    </div>

    <script>
        // アプリの状態管理
        const app = {
            parts: [],
            selectedSymbol: null,
            selectedBeatGroup: null, // { partId, row, measureIndex }
            flamEnabled: false,  // フラム装飾のON/OFF
            copiedRowData: null,  // コピーした行データ { rowConfig, cellSymbols: [記号配列] }
            partIdCounter: 0
        };

        // 記号定義（8種類：基本音6種 + ロール1種 + フラム装飾1種）
        const SYMBOLS = [
            { name: 'ベース', symbol: '□', isBasic: true },
            { name: 'トーン', symbol: '○', isBasic: true },
            { name: 'スラップ', symbol: '△', isBasic: true },
            { name: 'ベース(ミュート)', symbol: '■', isBasic: true },
            { name: 'トーン(ミュート)', symbol: '●', isBasic: true },
            { name: 'スラップ(ミュート)', symbol: '▲', isBasic: true },
            { name: 'ロール', symbol: '≡', isBasic: true },
            { name: 'フラム', symbol: '≈', isBasic: false }  // フラム装飾
        ];

        // 初期化
        function init() {
            loadFromLocalStorage();
            if (app.parts.length === 0) {
                addPart();
            }
            setupEventListeners();
            render();
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            document.getElementById('addPart').addEventListener('click', addPart);
            document.getElementById('saveBtn').addEventListener('click', saveToFile);
            document.getElementById('loadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', loadFromFile);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
        }

        // パート追加
        function addPart() {
            if (app.parts.length >= 4) {
                alert('パートは最大4つまでです');
                return;
            }
            const part = {
                id: app.partIdCounter++,
                name: `パート${app.parts.length + 1}`,
                notes: {},
                rowConfigs: [
                    { beats: [4, 4] },  // 1行目: 両小節とも4連
                    { beats: [4, 4] },  // 2行目
                    { beats: [4, 4] },  // 3行目
                    { beats: [4, 4] }   // 4行目
                ]
            };
            app.parts.push(part);
            render();
            saveToLocalStorage();
        }

        // パート削除
        function deletePart(partId) {
            app.parts = app.parts.filter(p => p.id !== partId);
            render();
            saveToLocalStorage();
        }

        // パート名更新
        function updatePartName(partId, newName) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;
            part.name = newName;
        }

        // 行追加
        function addRow(partId) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;
            part.rowConfigs.push({ beats: [4, 4] });  // デフォルトは両小節とも4連
            render();
            saveToLocalStorage();
        }

        // 小節の連数を切り替え（3連 ⇔ 4連）
        function toggleMeasureBeats(partId, row, measureIndex) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;
            const current = part.rowConfigs[row].beats[measureIndex];
            part.rowConfigs[row].beats[measureIndex] = current === 4 ? 3 : 4;
            render();
            saveToLocalStorage();
        }

        // 行をコピー
        function copyRow(partId, row) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;

            const rowConfig = part.rowConfigs[row];
            const cellsInRow = getCellsForRow(rowConfig);
            const cellSymbols = [];

            // 行内の各セルの記号を配列に保存
            for (let col = 0; col < cellsInRow; col++) {
                const position = calculatePosition(part, row, col);
                cellSymbols[col] = part.notes[position] || null;
            }

            app.copiedRowData = {
                rowConfig: { beats: [...rowConfig.beats] },
                cellSymbols: cellSymbols
            };

            render();
        }

        // 行に貼り付け
        function pasteRow(partId, row) {
            if (!app.copiedRowData) return;

            const part = app.parts.find(p => p.id === partId);
            if (!part) return;

            // rowConfigをコピー元と同じにする
            part.rowConfigs[row] = { beats: [...app.copiedRowData.rowConfig.beats] };

            // コピー元の記号配置を貼り付け
            const cellsInRow = getCellsForRow(part.rowConfigs[row]);
            for (let col = 0; col < cellsInRow; col++) {
                const position = calculatePosition(part, row, col);
                if (app.copiedRowData.cellSymbols[col]) {
                    part.notes[position] = app.copiedRowData.cellSymbols[col];
                } else {
                    delete part.notes[position];
                }
            }

            render();
            saveToLocalStorage();
        }

        // 指定行のマス数を取得
        function getCellsForRow(rowConfig) {
            return rowConfig.beats[0] + rowConfig.beats[1];
        }

        // 指定列が属する小節の情報を取得
        function getMeasureInfo(rowConfig, col) {
            const measure1Beats = rowConfig.beats[0];
            if (col < measure1Beats) {
                return { measureIndex: 0, beats: measure1Beats, startCol: 0 };
            } else {
                return { measureIndex: 1, beats: rowConfig.beats[1], startCol: measure1Beats };
            }
        }

        // 行とセルから累積positionを計算
        function calculatePosition(part, row, col) {
            let position = 0;
            // 前の行までの累積マス数を加算
            for (let r = 0; r < row; r++) {
                position += getCellsForRow(part.rowConfigs[r]);
            }
            // 現在の行のcol位置を加算
            position += col;
            return position;
        }

        // レンダリング
        function render() {
            const partsContainer = document.getElementById('parts');
            partsContainer.innerHTML = '';

            app.parts.forEach(part => {
                const partDiv = document.createElement('div');
                partDiv.className = 'part';

                // パートヘッダー
                const header = document.createElement('div');
                header.className = 'part-header';

                // パート名入力欄
                const partNameInput = document.createElement('input');
                partNameInput.type = 'text';
                partNameInput.className = 'part-title';
                partNameInput.value = part.name;
                partNameInput.addEventListener('input', (e) => updatePartName(part.id, e.target.value));
                partNameInput.addEventListener('blur', () => saveToLocalStorage());

                // 削除ボタン
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-part';
                deleteBtn.textContent = '削除';
                deleteBtn.onclick = () => deletePart(part.id);

                header.appendChild(partNameInput);
                header.appendChild(deleteBtn);
                partDiv.appendChild(header);

                // 音の種類ラベル
                const soundTypeLabel = document.createElement('div');
                soundTypeLabel.className = 'section-label';
                soundTypeLabel.textContent = '音の種類';
                partDiv.appendChild(soundTypeLabel);

                // 記号パレット
                const palette = document.createElement('div');
                palette.className = 'symbol-palette';
                SYMBOLS.forEach((sym, index) => {
                    // フラムの前に区切り線を挿入
                    if (!sym.isBasic && index > 0) {
                        const divider = document.createElement('div');
                        divider.className = 'symbol-divider';
                        palette.appendChild(divider);
                    }

                    const item = document.createElement('div');
                    item.className = 'symbol-item';

                    const btn = document.createElement('button');
                    btn.className = 'symbol-btn';
                    // 現在選択中の記号と一致する場合、selectedクラスを追加
                    if (app.selectedSymbol === sym.symbol) {
                        btn.classList.add('selected');
                    }
                    // フラム記号がONの場合、フラムボタンを選択状態に
                    if (sym.symbol === '≈' && app.flamEnabled) {
                        btn.classList.add('selected');
                    }
                    // フラム装飾がONで基本音が選択されている場合、ボタンにフラムを表示
                    if (app.flamEnabled && sym.isBasic && app.selectedSymbol === sym.symbol) {
                        btn.textContent = sym.symbol + '≈';
                    } else {
                        btn.textContent = sym.symbol;
                    }
                    btn.title = sym.name;
                    btn.onclick = () => selectSymbol(part.id, sym.symbol);

                    const label = document.createElement('div');
                    label.className = 'symbol-label';
                    label.textContent = sym.name;

                    item.appendChild(btn);
                    item.appendChild(label);
                    palette.appendChild(item);
                });
                partDiv.appendChild(palette);

                // 譜面欄ラベル
                const scoreLabel = document.createElement('div');
                scoreLabel.className = 'section-label';
                scoreLabel.textContent = '譜面欄';
                partDiv.appendChild(scoreLabel);

                // グリッド
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid-container';

                const rows = part.rowConfigs.length;

                // 行ごとにグリッドを作成
                for (let row = 0; row < rows; row++) {
                    const rowConfig = part.rowConfigs[row];
                    const gridRow = document.createElement('div');
                    gridRow.className = 'grid-row';

                    // 行ラベル
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = `${row + 1}:`;
                    gridRow.appendChild(rowLabel);

                    // セルコンテナ
                    const gridCells = document.createElement('div');
                    gridCells.className = 'grid-cells';

                    const cellsInRow = getCellsForRow(rowConfig);

                    for (let col = 0; col < cellsInRow; col++) {
                        const position = calculatePosition(part, row, col);
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';

                        // 小節の区切り（各小節の開始位置）
                        const measureInfo = getMeasureInfo(rowConfig, col);
                        if (col === 0 || col === measureInfo.startCol) {
                            cell.classList.add('measure-start');
                        }

                        // ビートグループ選択状態のハイライト
                        if (app.selectedBeatGroup &&
                            app.selectedBeatGroup.partId === part.id &&
                            app.selectedBeatGroup.row === row &&
                            app.selectedBeatGroup.measureIndex === measureInfo.measureIndex) {
                            cell.classList.add('beat-selected');
                        }

                        // 配置されている記号を表示
                        if (part.notes[position]) {
                            cell.textContent = part.notes[position];
                            cell.classList.add('has-symbol');
                        }

                        cell.onclick = () => placeOrRemoveSymbol(part.id, position, row, col);
                        gridCells.appendChild(cell);
                    }

                    gridRow.appendChild(gridCells);

                    // 小節ごとの4連/3連切り替えボタン
                    const beatControls = document.createElement('div');
                    beatControls.className = 'beat-controls';

                    // 小節1の切り替えボタン
                    const toggle1 = document.createElement('button');
                    toggle1.className = 'beat-toggle';
                    toggle1.classList.add(rowConfig.beats[0] === 4 ? 'active-4' : 'active-3');
                    toggle1.textContent = rowConfig.beats[0] === 4 ? '4連' : '3連';
                    toggle1.onclick = () => toggleMeasureBeats(part.id, row, 0);
                    beatControls.appendChild(toggle1);

                    // 小節2の切り替えボタン
                    const toggle2 = document.createElement('button');
                    toggle2.className = 'beat-toggle';
                    toggle2.classList.add(rowConfig.beats[1] === 4 ? 'active-4' : 'active-3');
                    toggle2.textContent = rowConfig.beats[1] === 4 ? '4連' : '3連';
                    toggle2.onclick = () => toggleMeasureBeats(part.id, row, 1);
                    beatControls.appendChild(toggle2);

                    gridRow.appendChild(beatControls);

                    // 行コピー・貼り付けボタン
                    const rowActionControls = document.createElement('div');
                    rowActionControls.className = 'row-action-controls';

                    // コピーボタン
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'beat-toggle';
                    copyBtn.textContent = 'コピー';
                    copyBtn.onclick = () => copyRow(part.id, row);
                    rowActionControls.appendChild(copyBtn);

                    // 貼り付けボタン
                    const pasteBtn = document.createElement('button');
                    pasteBtn.className = 'beat-toggle';
                    pasteBtn.textContent = '貼付';
                    pasteBtn.style.cssText = app.copiedRowData ?
                        'background: #27ae60; color: white; border-color: #27ae60;' :
                        'opacity: 0.5; cursor: not-allowed;';
                    pasteBtn.disabled = !app.copiedRowData;
                    pasteBtn.onclick = () => pasteRow(part.id, row);
                    rowActionControls.appendChild(pasteBtn);

                    gridRow.appendChild(rowActionControls);
                    gridContainer.appendChild(gridRow);
                }

                // 行追加ボタン
                const addRowButton = document.createElement('button');
                addRowButton.className = 'add-row-btn';
                addRowButton.textContent = '+ 行を追加';
                addRowButton.onclick = () => addRow(part.id);
                gridContainer.appendChild(addRowButton);

                partDiv.appendChild(gridContainer);
                partsContainer.appendChild(partDiv);
            });
        }

        // 記号選択
        function selectSymbol(partId, symbol) {
            // フラム記号の場合はフラム装飾をON/OFF
            if (symbol === '≈') {
                app.flamEnabled = !app.flamEnabled;
            } else {
                if (app.selectedSymbol === symbol) {
                    app.selectedSymbol = null;
                } else {
                    app.selectedSymbol = symbol;
                }
            }
            render();
        }

        // 記号の配置または削除
        function placeOrRemoveSymbol(partId, position, row, col) {
            const part = app.parts.find(p => p.id === partId);
            if (!part) return;

            // ビートグループ選択状態を更新
            const rowConfig = part.rowConfigs[row];
            const measureInfo = getMeasureInfo(rowConfig, col);
            app.selectedBeatGroup = {
                partId: partId,
                row: row,
                measureIndex: measureInfo.measureIndex
            };

            // 記号を配置（常に上書き）
            if (app.selectedSymbol) {
                // フラム装飾がONで、かつロール（≡）でない場合はフラム記号を付加
                if (app.flamEnabled && app.selectedSymbol !== '≡') {
                    part.notes[position] = app.selectedSymbol + '≈';
                } else {
                    part.notes[position] = app.selectedSymbol;
                }
            }

            render();
            saveToLocalStorage();
        }

        // ファイルに保存
        function saveToFile() {
            const data = {
                parts: app.parts.map(p => ({
                    name: p.name,
                    rowConfigs: p.rowConfigs,
                    notes: p.notes
                }))
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `djembe-score-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ファイルから読込
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    app.parts = data.parts.map((p, index) => ({
                        id: app.partIdCounter++,
                        name: p.name || `パート${index + 1}`,
                        rowConfigs: p.rowConfigs || [{ beats: [4, 4] }],
                        notes: p.notes || {}
                    }));

                    render();
                    saveToLocalStorage();
                    alert('譜面を読み込みました');
                } catch (error) {
                    alert('ファイルの読み込みに失敗しました');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // LocalStorageに保存
        function saveToLocalStorage() {
            try {
                const data = {
                    parts: app.parts,
                    partIdCounter: app.partIdCounter
                };
                localStorage.setItem('djembeScore', JSON.stringify(data));
            } catch (error) {
                console.error('LocalStorageへの保存に失敗:', error);
            }
        }

        // LocalStorageから読込
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('djembeScore');
                if (data) {
                    const parsed = JSON.parse(data);
                    app.parts = (parsed.parts || []).map(p => ({
                        ...p,
                        rowConfigs: p.rowConfigs || [{ beats: [4, 4] }]
                    }));
                    app.partIdCounter = parsed.partIdCounter || 0;
                }
            } catch (error) {
                console.error('LocalStorageからの読み込みに失敗:', error);
            }
        }

        // 全クリア
        function clearAll() {
            if (confirm('すべてのデータをクリアしますか？')) {
                app.parts = [];
                app.selectedSymbol = null;
                app.selectedBeatGroup = null;
                app.partIdCounter = 0;
                addPart();
                saveToLocalStorage();
            }
        }

        // アプリ起動
        init();
    </script>
</body>
</html>
